{
  "active": false,
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          },
          {
            "node": "Postgres1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Postgres2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Postgres3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2022-08-11T17:30:04.516Z",
  "id": "32",
  "name": "G_WBR",
  "nodes": [
    {
      "parameters": {},
      "id": "b2e4da46-2f93-4794-ba55-98cd65093fea",
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT partner.code,\n    commerce.code,\n    count(*) total\nFROM policy.\"Policy\" p\n        inner join policy.\"PolicyDetail\" PD on p.id = PD.\"policyId\"\n        inner join common.\"Partner\" partner on p.\"partnerId\" = partner.id\n        inner join common.\"Commerce\" commerce on partner.\"commerceId\" = commerce.id\nWHERE PD.\"endDate\" < Date('08-06-2022')\nAND PD.\"endDate\" > Date('08-01-2022')\ngroup by partner.code, commerce.code;",
        "additionalFields": {}
      },
      "id": "e9793e08-387a-489c-9907-82b33b0608cd",
      "name": "Postgres",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        440,
        180
      ],
      "credentials": {
        "postgres": {
          "id": "18",
          "name": "GP_Vehicle"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT vi.vin, d.\"endDate\", d.\"startDate\", partner.code partnerCode, C.code commerceCode\nFROM policy.\"Policy\" p\n        INNER JOIN vehicle.\"Vehicle\" vi ON p.\"vehicleId\" = vi.id\n        INNER JOIN policy.\"PolicyDetail\" d on p.id = d.\"policyId\"\n        INNER JOIN common.\"Partner\" partner ON p.\"partnerId\" = partner.id\n        INNER JOIN common.\"Commerce\" C on C.id = partner.\"commerceId\"\nWHERE vi.vin in (\n    SELECT v.vin\n    FROM policy.\"Policy\" pd\n            INNER JOIN vehicle.\"Vehicle\" v ON pd.\"vehicleId\" = v.id\n    WHERE v.vin not in ('SN', '')\n    GROUP BY v.vin\n    HAVING count(*) > 1\n)\nGROUP BY vi.vin, d.\"endDate\", d.\"startDate\", d.\"createdDate\", partner.code, C.code\nHAVING  d.\"startDate\" < Date('08-06-2022')\n    AND d.\"startDate\" > Date('08-01-2022');",
        "additionalFields": {}
      },
      "id": "6085065f-ccfc-41ca-b93f-4c9b9b239c7c",
      "name": "Postgres1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        440,
        320
      ],
      "credentials": {
        "postgres": {
          "id": "18",
          "name": "GP_Vehicle"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT date_part('week', PD.\"endDate\"::date) AS weekly,\n    partner.code,\n    count(*)                                 total\nFROM policy.\"Policy\" p\n        inner join policy.\"PolicyDetail\" PD on p.id = PD.\"policyId\"\n        inner join common.\"Partner\" partner on p.\"partnerId\" = partner.id\nWHERE PD.\"endDate\" <= Date('08-10-2022')\nAND PD.\"endDate\" >= Date('06-01-2022')\ngroup by partner.code, weekly\norder by weekly asc;",
        "additionalFields": {}
      },
      "id": "94e8d671-661c-45ef-a82c-0e4c78ded03b",
      "name": "Postgres2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        440,
        460
      ],
      "credentials": {
        "postgres": {
          "id": "18",
          "name": "GP_Vehicle"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT count(*) total, Reneweds.weekly, Reneweds.partner\nFROM (\n    SELECT vi.vin,\n            d.\"endDate\",\n            d.\"startDate\",\n            partner.code                              partner,\n            date_part('week', d.\"startDate\"::date) AS weekly\n    FROM policy.\"Policy\" p\n            INNER JOIN vehicle.\"Vehicle\" vi ON p.\"vehicleId\" = vi.id\n            INNER JOIN policy.\"PolicyDetail\" d on p.id = d.\"policyId\"\n            INNER JOIN common.\"Partner\" partner ON p.\"partnerId\" = partner.id\n    WHERE vi.vin in (\n        SELECT v.vin\n        FROM policy.\"Policy\" pd\n                INNER JOIN vehicle.\"Vehicle\" v ON pd.\"vehicleId\" = v.id\n        WHERE v.vin not in ('SN', '') -- to remove vin trash \n        GROUP BY v.vin\n        HAVING count(*) > 1\n    )\n    GROUP BY vi.vin, d.\"endDate\", d.\"startDate\", d.\"createdDate\", partner.code, weekly\n    HAVING d.\"startDate\" < Date('08-10-2022')\n        AND d.\"startDate\" > Date('06-01-2022')\n    ORDER BY weekly ASC\n) AS Reneweds\nGROUP BY Reneweds.partner, Reneweds.weekly;",
        "additionalFields": {}
      },
      "id": "f3066de5-57c6-4877-943d-0240e31d9bfe",
      "name": "Postgres3",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        440,
        600
      ],
      "credentials": {
        "postgres": {
          "id": "18",
          "name": "GP_Vehicle"
        }
      }
    }
  ],
  "pinData": {
    "Postgres": [
      {
        "json": {
          "code": "guros",
          "total": "21"
        }
      },
      {
        "json": {
          "code": "guros",
          "total": "39"
        }
      },
      {
        "json": {
          "code": "guros",
          "total": "92"
        }
      }
    ]
  },
  "settings": {},
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2022-08-15T18:36:38.981Z",
  "versionId": "34f5f782-adae-4f9b-861a-10a62e6fad6d"
}